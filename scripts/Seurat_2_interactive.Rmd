---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
#这里是seurat的交互功能

## Setup the Seurat Object

```{r}
library(dplyr)
library(Seurat)
library(patchwork)
library(loomR)
library(Matrix)
library(future)
# Enable parallelization
#并行计算可以提高如下函数在muilt-下的工作效率
#NormalizeData()
# ScaleData()
# JackStraw()
# FindMarkers()
# FindIntegrationAnchors()
# FindClusters() - if clustering over multiple resolutions
plan("multiprocess", workers = 6)
```


```{r labelplot1, fig.height=5, fig.width=5}
larva <- readRDS("larva_final.rds")
#使用这个方法从metadata中找到原始的cluster
Idents(larva) <- larva@meta.data[["seurat_clusters"]]

#找到1和2分离的markers
cluster1.markers <- FindMarkers(larva, ident.1 = 1, ident.2 = 2, min.pct = 0.3,
                                logfc.threshold = 0.5)
cluster1.markers

#feature plot，这里的feature指定的是初始的显示基因
#交互的feature plot
IFeaturePlot(larva,feature = "H15")

```

##手动选择细胞亚群
```{r labelplot, fig.height=5, fig.width=5}
#手动选择细胞亚群,select.cells存储选择的细胞，这里选了左下角
select.cells <- CellSelector(plot = DimPlot(larva, reduction = "umap"))

#更改这个细胞亚群的名字
Idents(larva,cells = select.cells) <- "selected"
levels(larva)
DimPlot(larva,reduction = "umap",label = T)

#寻找将它和其他所有细胞亚群区分开来的markers
selected.cells.markers <- FindMarkers(larva, ident.1 = "selected", ident.2 = levels(larva)[levels(larva)!="selected"], min.pct = 0.4,
                                logfc.threshold = 0.5)

#这是一个dataframe
selected.cells.markers

#选取几个主要的clusters，画图好看一点
larva_principle_clusters <- subset(larva,idents = c(0:5,"selected"))
```
##在ggplot2对象上加label
```{r}
plot <- DimPlot(larva, reduction = "tsne") + NoLegend()
LabelClusters(plot = plot, id = "ident")
```

##对选择的clusters的markers进行可视化
```{r labelplot , fig.height=10, fig.width=20}
#小提琴图
VlnPlot(larva_principle_clusters, features <- head(rownames(selected.cells.markers),9),pt.size=0)
#在UMAP上显示
FeaturePlot(larva, features = head(rownames(selected.cells.markers),9))
#艺术的波浪线
RidgePlot(larva_principle_clusters, features = head(rownames(selected.cells.markers),8), ncol = 2)
#点阵图
DotPlot(larva,features = head(rownames(selected.cells.markers),20))
#heat map
DoHeatmap(larva_principle_clusters, features = head(rownames(selected.cells.markers),100)) + NoLegend()
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
