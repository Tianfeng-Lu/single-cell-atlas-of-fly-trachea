---
title: "DEGs analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

# Part 3
## 细胞亚群差异分析
```{r setup, include=FALSE}
getwd()
knitr::opts_knit$set(root.dir = "/home/zju/tianfeng/single_cell_atlas")
# setwd("/home/zju/tianfeng/single_cell_atlas")
# getwd()
```


## start with fly_merge_filtered.rds
## HSD vs ctrl
```{r}
fly_merge_filtered <- readRDS("./processed_data_file/fly_merge_filtered.rds")
Idents(fly_merge_filtered) <- fly_merge_filtered$orig.ident
fly_merge_filtered <- RenameIdents(fly_merge_filtered, '1' = 'ctrl', '2' = 'HSD', '3' = 'HSD')
fly_merge_filtered$condition <- Idents(fly_merge_filtered)
Idents(fly_merge_filtered) <- fly_merge_filtered$celltype

umapplot(fly_merge_filtered, split.by = "condition", label.size = 5) %>% ggsave("./temp/umap_HSD_split.png", device = png, width = 7, height = 4, plot = .)
```



## PC and DB
```{r}
Idents(fly_merge_filtered) <- fly_merge_filtered$condition
fly_DEGs <- FindMarkers(subset(fly_merge_filtered, celltype == "PC"), 
                              ident.1 = "HSD", ident.2 = "ctrl", test.use = "DESeq2", logfc.threshold = 0.4, min.pct = 0.1, min.diff.pct = 0.1, only.pos = F, pseudocount.use = 1)

fly_DEGs$diff.pct <- fly_DEGs$pct.1 - fly_DEGs$pct.2
fly_DEGs$gene <- rownames(fly_DEGs)
write.csv(fly_DEGs,"./data_tables/PC_HSDvsctrl.csv")
```
```{r}
Idents(fly_merge_filtered) <- fly_merge_filtered$condition
fly_DEGs <- FindMarkers(subset(fly_merge_filtered, celltype == "DB"), 
                              ident.1 = "HSD", ident.2 = "ctrl", test.use = "wilcox",logfc.threshold = 0.5, min.pct = 0.1, min.diff.pct = 0.1, only.pos = F, pseudocount.use = 0)

fly_DEGs$diff.pct <- fly_DEGs$pct.1 - fly_DEGs$pct.2
fly_DEGs$gene <- rownames(fly_DEGs)
write.csv(fly_DEGs,"./data_tables/DB_HSDvsctrl.csv")
```

#### 参考这个 https://cloud.tencent.com/developer/article/1925869
```{r fig.height=5, fig.width=8}
PC_DEGs <- read.csv("./data_tables/PC_HSDvsctrl.csv")

pvalue_threshold = 0.01
logFC_threshold = 0.7
diff.pct_threshold = 0.1

# pvalue_threshold = 0.001
# logFC_threshold = 0
# diff.pct_threshold = 0


PC_DEGs$threshold <-  factor(ifelse(PC_DEGs$p_val_adj < pvalue_threshold & 
                                             abs(PC_DEGs$avg_log2FC) >= logFC_threshold &
                                             abs(PC_DEGs$diff.pct) >= diff.pct_threshold, 
                              ifelse(PC_DEGs$avg_log2FC>= logFC_threshold ,'Up','Down'),'N.S.'),
                       levels=c('Up','Down','N.S.'))

selected_genes <- PC_DEGs$gene[!PC_DEGs$threshold == 'N.S.']
# selected_genes <- notch2

ggplot(data = PC_DEGs) + 
  geom_point(aes(x = diff.pct, y = avg_log2FC, color = threshold),size = 4)+
    scale_color_manual(values=c("#CC0000","#2f5688","#BBBBBB"))+
  geom_text_repel(
      data = PC_DEGs[PC_DEGs$gene %in% selected_genes,],
      aes(x = diff.pct, y = avg_log2FC, label = gene),
      size = 7, max.overlaps = 100,
      col="black", segment.color = "black", show.legend = FALSE) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"))+
    theme(
      axis.title.x = element_text(size = 20), axis.text.x = element_text(colour = "black", size = 15),
      axis.title.y = element_text(size = 20), axis.text.y = element_text(colour = "black", size = 15), 
      legend.text = element_text(size = 20), 
      legend.title = element_blank()) +
    xlab('diff.pct') + ylab('avg_log2FC') +
    geom_hline(yintercept=c(-logFC_threshold,logFC_threshold), lty=3,col="black",lwd=0.5) +
    geom_vline(xintercept=c(-diff.pct_threshold,diff.pct_threshold), lty=3,col="black",lwd=0.5) + ggtitle('ctrl vs HSD PC')
```

## PC DEGs GO
```{r}
library(org.Dm.eg.db)

# 合并up&down
selected_genes <- PC_DEGs$gene[!PC_DEGs$threshold == 'N.S.']
genes <- bitr(selected_genes, fromType="SYMBOL",toType=c("ENTREZID","ENSEMBL"),
                 OrgDb = org.Dm.eg.db)

enrich.go <- enrichGO(gene = genes$ENTREZID, #基因列表文件中的基因名称
                        OrgDb = org.Dm.eg.db,
                        keyType = 'ENTREZID',
                        ont = 'BP', #可选 BP、MF、CC，也可以指定 ALL 同时计算 3 者
                        pAdjustMethod = 'fdr',
                        pvalueCutoff = 0.05, 
                        qvalueCutoff = 0.05, 
                        readable = TRUE)

df1 <- compute_enrichment_factor(enrich.go)
ggplot(df1 %>% filter(ID %in% c("GO:0035329","GO:0030335",'GO:0072091','GO:2000145','GO:0035150','GO:0001708','GO:0007219','GO:0032868','GO:0009894','GO:0042325','GO:0009991','GO:0030036'))%>% arrange(desc(enrichment_factor)), aes(x=enrichment_factor, y=factor(Description, levels = rev(Description)), fill=p.adjust)) + geom_col() + scale_fill_gradient(low = "#fd9999", high = "#b1d6fb") + 
  xlim(0,NA) + labs(x="enrichment factor", y="selected GO terms") + theme_bw()  + 
  theme(text = element_text(colour = "black", size = 16), 
        plot.title = element_text(size = 16,color="black",hjust = 0.5),
        axis.title = element_text(size = 16,color ="black"), 
        axis.text = element_text(size= 16,color = "black"), panel.grid=element_blank()) #'GO:0045746'


```

### DB GO HSD vs ctrl
```{r}
pvalue_threshold = 0.01
logFC_threshold = 0.3
diff.pct_threshold = 0.1

fly_DEGs <- read.csv("./data_tables/DB_HSDvsctrl.csv",row.names = 1)
fly_DEGs$threshold <-  factor(ifelse(fly_DEGs$p_val_adj < pvalue_threshold & 
                                             abs(fly_DEGs$avg_log2FC) >= logFC_threshold &
                                             abs(fly_DEGs$diff.pct) >= diff.pct_threshold, 
                              ifelse(fly_DEGs$avg_log2FC>= logFC_threshold ,'Up','Down'),'N.S.'),
                       levels=c('Up','Down','N.S.'))
# 合并up&down
selected_genes <- fly_DEGs$gene[!fly_DEGs$threshold == 'N.S.']
genes <- bitr(selected_genes, fromType="SYMBOL",toType=c("ENTREZID","ENSEMBL"),
                 OrgDb = org.Dm.eg.db)
enrich.go <- enrichGO(gene = genes$ENTREZID, #基因列表文件中的基因名称
                        OrgDb = org.Dm.eg.db,
                        keyType = 'ENTREZID',
                        ont = 'BP', #可选 BP、MF、CC，也可以指定 ALL 同时计算 3 者
                        pAdjustMethod = 'fdr',
                        pvalueCutoff = 0.05, 
                        qvalueCutoff = 0.2, 
                        readable = TRUE)
barplot(enrich.go)+ theme_classic() + 
  theme(text = element_text(colour = "black", size = 16), 
        plot.title = element_text(size = 16,color="black",hjust = 0.5),
        axis.title = element_text(size = 16,color ="black"), 
        axis.text = element_text(size= 16,color = "black"))

write.csv(enrich.go@result,"./data_tables/GO_all_DB_HSDvsctrl.csv")
```

## NOTCH target in {PC}

```{r}
upgenes <- fly_DEGs$gene[fly_DEGs$threshold == 'Up']
upgenes <- na.omit(upgenes)
downgenes <- fly_DEGs$gene[fly_DEGs$threshold == 'Down']

notchDEGs <- readxl::read_excel("Notch_target/notchDN_WT_results.xlsx")

notch1 <- notchDEGs$external_gene_name[notchDEGs$padj<0.001]
notch1 <- notch1[notch1!="NA"]
notch2 <- notchDEGs$external_gene_name[notchDEGs$log2FoldChange<(-0.5) & notchDEGs$padj<0.0001]

intersect(notch1, upgenes)
intersect(notch1, downgenes)
intersect(notch2, upgenes)
```

```{r}
filename <- "scRNA_upgenes.png"

temp <- list(notch1, upgenes)
names(temp) = c("notch p<0.001","scRNA_upgenes p<0.001")

VennDiagram::venn.diagram(temp, fill = c("#1E90FF", "#ff2121"),
             filename = filename, imagetype = "png", 
             cat.dist = c(0.055, 0.055), #注释相对圆的距离
             cat.pos = c(0, 180),  #注释相对圆的角度
             alpha = 0.60) #透明度
# display(readImage(filename), method="raster")


# inter <- get.venn.partitions(DEGslist)
# filename <- "upgenes.csv"
# for (i in 1:nrow(inter)) 
#   inter[i,'values'] <- paste(inter[[i,'..values..']], collapse = ', ')
# inter <- inter[-which(colnames(inter) %in%  
#                                 c("..set..","..values.."))]
# inter <- inter[which(inter$..count..>0),] 
# write.csv(inter, filename, row.names = FALSE, quote = FALSE)
# inter
```

---

# overall: HSD vs ctrl
```{r fig.width=8, fig.height=5}
Idents(fly_merge_filtered) <- fly_merge_filtered$condition
fly_DEGs <- FindMarkers(fly_merge_filtered, ident.1 = "HSD", ident.2 = "ctrl", test.use = "DESeq2", only.pos = F)

pvalue_threshold = 0.0001
logFC_threshold = 0.3
diff.pct_threshold = 0.2
fly_DEGs$diff.pct <- fly_DEGs$pct.1 - fly_DEGs$pct.2
fly_DEGs$gene <- rownames(fly_DEGs)
fly_DEGs$threshold <-  factor(ifelse(fly_DEGs$p_val_adj < pvalue_threshold & 
                                             abs(fly_DEGs$avg_logFC) >= logFC_threshold &
                                             abs(fly_DEGs$diff.pct) >= diff.pct_threshold, 
                              ifelse(fly_DEGs$avg_logFC>= logFC_threshold ,'Up','Down'),'N.S.'),
                       levels=c('Up','Down','N.S.'))

selected_genes <- fly_DEGs$gene[!fly_DEGs$threshold == 'N.S.']


ggplot(data = fly_DEGs) + 
  geom_point(aes(x = diff.pct, y = avg_logFC, color = threshold),size = 4)+
    scale_color_manual(values=c("#CC0000","#2f5688","#BBBBBB"))+
  geom_text_repel(
      data = fly_DEGs[fly_DEGs$gene %in% selected_genes,],
      aes(x = diff.pct, y = avg_logFC, label = gene),
      size = 7, max.overlaps = 100,
      col="black", segment.color = "black", show.legend = FALSE) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          panel.background = element_blank(), axis.line = element_line(colour = "black"))+
    theme(
      axis.title.x = element_text(size = 20), axis.text.x = element_text(color = "black", size = 15),
      axis.title.y = element_text(size = 20), axis.text.y = element_text(color = "black",size = 15), 
      legend.text = element_text(size = 20), 
      legend.title = element_blank()) +
    xlab('diff.pct') + ylab('avg_logFC') +
    geom_hline(yintercept=c(-logFC_threshold,logFC_threshold), lty=3,col="black",lwd=0.5) +
    geom_vline(xintercept=c(-diff.pct_threshold,diff.pct_threshold), lty=3,col="black",lwd=0.5)
```

### 作图
```{r}
library(EnhancedVolcano)
EnhancedVolcano(fly_DEGs, lab = rownames(fly_DEGs),
                x = 'avg_logFC', y = 'p_val_adj',
                pCutoff = 0.0001, FCcutoff = 1,
                pointSize = 3.0, labSize = 6.0, title = 'diff_EC')

```


```{r}
for(i in c(1:25)){
  fly_merge_filtered[[paste0("antigen_score",as.character(i))]] <- NULL
}
```

# 可视化各celltype的DEG HSD vs ctrl
```{r}
Idents(fly_merge_filtered) <- fly_merge_filtered$condition
res <- lapply(unique(fly_merge_filtered$celltype), function(x){fly_DEGs <- FindMarkers(subset(fly_merge_filtered, celltype == x), ident.1 = "HSD", ident.2 = "ctrl", test.use = "wilcox",logfc.threshold = 0.5, min.pct = 0.1, min.diff.pct = 0.1, only.pos = F, pseudocount.use = 0)
fly_DEGs$diff.pct <- fly_DEGs$pct.1 - fly_DEGs$pct.2
fly_DEGs$gene <- rownames(fly_DEGs)
fly_DEGs$cluster <- x
return(fly_DEGs)})

merged_result <- Reduce(rbind, res)

# set boundary and p cutoff
merged_result <- merged_result %>% filter(p_val_adj < 0.05) %>% filter(!(cluster %in% c("ASP", "GB"))) 
merged_result$avg_log2FC[merged_result$avg_log2FC > 4] <- 4
merged_result$avg_log2FC[merged_result$avg_log2FC < -2] <- -2


source("./utils/scVolcano.R")
scVolcano(merged_result, annoH = 0.3, myMarkers=c("fng","kud","E(spl)m2-BFM","	
E(spl)m3-HLH","E(spl)m7-HLH","Tom"), topGeneN = 3, seed=143)
# ggsave("./figures/cluster_DEGs_HSDvsctrl.png", dpi = 256, width = 8, height = 6)

# saveRDS(merged_result, "./processed_data_file/forfig_merged_DEGs_HSDvsCtrl.rds")
```

# 功能分析
```{r fig.height=2, fig.width=5}
selected_genes <- unique(merged_result$gene)
genes <- bitr(selected_genes, fromType="SYMBOL",toType=c("ENTREZID","ENSEMBL"),
                 OrgDb = org.Dm.eg.db)

enrich.go <- enrichGO(
        gene = genes$ENTREZID, # 基因列表文件中的基因名称
        OrgDb = org.Dm.eg.db,
        keyType = "ENTREZID",
        ont = "BP", # 可选 BP、MF、CC，也可以指定 ALL 同时计算 3 者
        pAdjustMethod = "fdr",
        pvalueCutoff = 0.05,
        qvalueCutoff = 0.01,
        readable = TRUE
    )
barplot(enrich.go, title = paste("HSDvscontrol", "GO"), showCategory = 15) + 
  theme_classic()

df1 <- compute_enrichment_factor(enrich.go)
# write.csv(df1, "./data_tables/merged_result_HSDvsCTRL_enrichment.csv")

ggplot(df1 %>% filter(ID %in% c('GO:0045747','GO:0007219','GO:0008593','GO:0035330','GO:0032869'))%>% arrange(desc(enrichment_factor)), aes(x=enrichment_factor, y=factor(Description, levels = rev(Description)), fill=p.adjust)) + geom_col() + scale_fill_gradient(low = "#fd9999", high = "#b1d6fb") + 
  xlim(0,NA) + labs(x="enrichment factor", y="Notch related GO terms") + theme_bw()  + 
  theme(text = element_text(colour = "black", size = 16), 
        plot.title = element_text(size = 16,color="black",hjust = 0.5),
        axis.title = element_text(size = 16,color ="black"), 
        axis.text = element_text(size= 16,color = "black"), panel.grid=element_blank()) #'GO:0045746' "negative regulation of Notch signaling pathway" is excluded due to p > 0.1
# ggsave("./figures/cluster_DEGs_NOTCH_GO.png", dpi = 128, height = 4, width = 15)
```



