---
title: "10x figures"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/home/zju/tianfeng/single_cell_atlas")
```

```{r}
source("utils/tianfengRwrappers.R")
```

```{r fig.height=3, fig.width=3}
ctrl_filtered <- readRDS("./processed_data_file/ctrl_filtered.rds")
# umap = ctrl_filtered@reductions$umap@cell.embeddings %>%  as.data.frame()
# ctrl_filtered$celltype <- factor(ctrl_filtered$celltype,levels=c("DB","DT","SB","PC","TC","VB","LT","GB","ASP"))

df2 <- FetchData(ctrl_filtered, c("UMAP_1", "UMAP_2", "celltype"))

ggobj <- ggplot(df2) + geom_point(aes(x=`UMAP_1`,y=`UMAP_2`,fill=celltype), alpha=1, shape=21, color="white",size=2, stroke=0.2) + scale_fill_manual(values = colors_list) + coord_fixed(ratio=0.8) + theme_void() + guides(fill = guide_legend(override.aes = list(size = 5)))
ggobj <- LabelClusters(plot = ggobj, id = "celltype", repel = F, size = 3)
ggsave("./figures/fly10x figures/umapplot4.tiff",device = 'tiff', plot=ggobj, width = 5, height = 5, dpi = 300)

# # 
# umapplot(ctrl_filtered, group.by = "celltype", pt.size=2) + theme(axis.line = element_blank(), axis.title = element_blank(),legend.position = 'right')+coord_fixed(ratio = 1.2)
# ggsave("./figures/fly10x figures/umapplot3.tiff",device = 'tiff',width = 5, height = 5, dpi = 300)
```


```{r}
for(gene in c("salm","kni","ct", "vn", "wg", "bs", "Tom", "serp")){ 
  print(f(gene, ctrl_filtered, pt.size=2) + theme(axis.line = element_blank(), axis.title = element_blank(), legend.position = 'right')+coord_fixed(ratio = 0.8))
  ggsave(paste0("./figures/feature_plots/", gene, ".png"), dpi=256, height = 5, width = 5)
}

```

```{r}
for(gene in c("salm","kni","ct", "vn", "wg", "bs", "Tom", "serp")){
  print(RidgePlot(ctrl_filtered, features = gene) + theme(legend.position = "none"))
  ggsave(paste0("./figures/Ridge_plots/", gene, ".png"), dpi=256, height = 5, width = 5)}
```

```{r}
cf_selected <- subset(ctrl_filtered, idents=c("DB","DT","SB","PC","TC","VB"))
for(gene in c("salm","kni","ct", "vn", "wg", "bs", "Tom", "serp")){
  print(RidgePlot(cf_selected, features = gene, idents = c("DB","DT","SB","PC","TC","VB")) + theme(legend.position = "none"))
  ggsave(paste0("./figures/Ridge_plots/", gene, ".png"), dpi=256, height = 5, width = 5)}
```

```{r}
ctrl_filtered <- readRDS("./processed_data_file/ctrl_filtered.rds")
# umap = ctrl_filtered@reductions$umap@cell.embeddings %>%  as.data.frame()
# ctrl_filtered$celltype <- factor(ctrl_filtered$celltype,levels=c("DB","DT","SB","PC","TC","VB","LT","GB","ASP"))
```
```{r}
cf_selected <- subset(ctrl_filtered, idents=c("DB","DT","SB","PC","TC","VB"))
```

```{r}
RidgePlot(cf_selected, features = "wg")+theme(legend.position = "none", panel.grid = element_blank())+
  coord_fixed(ratio = 1/16)+xlim(c(0.5,1.9))+coord_cartesian(xlim = c(0.6, 1.9))

```


```{r}
for(gene in c("salm","kni","ct", "vn", "wg", "bs", "Tom", "serp")){
  print(RidgePlot(cf_selected, features = gene, idents = c("DB","DT","SB","PC","TC","VB")) + theme(legend.position = "none"), panel.grid=element_blank())}
```


```{r}
ctrl$celltype <- factor(ctrl$celltype, levels=c(levels(ctrl_filtered$celltype), setdiff(levels(ctrl$celltype), levels(ctrl_filtered$celltype)))) # 调整一下因子顺序

umapplot(ctrl, group.by = "celltype") + theme(axis.line = element_blank(),axis.title = element_blank(),legend.position = 'right')+coord_fixed(ratio = 1) 
ggsave("./figures/fly10x figures/umapplot3.tiff",device = 'tiff',width = 7, height = 7, dpi = 300)
```


```{r fig.height=5, fig.width=5}
Idents(ctrl_filtered) <- ctrl_filtered$celltype
ctrl.markers <- FindAllMarkers(ctrl_filtered, min.pct = 0.1, 
                                    logfc.threshold = 0.5, only.pos = T)
top5markers <- ctrl.markers %>% group_by(cluster) %>% slice_max(n = 5, order_by = avg_log2FC)
markers_heatmap <- dhm(top5markers$gene, ctrl_filtered,text_size = 6,angle=0)
(markers_heatmap + theme(axis.text = element_text(size= 14, color = "black")))%>%
  ggsave(filename = "./figures/fly10x figures/ctrl_markergene.tiff", device = 'tiff', height = 8, width = 15,dpi = 128, plot = .)
write.csv(ctrl.markers,"./data_tables/ctrl_markers_fig1.csv")
```


## tracksplot
```{r tracksplot, fig.height=3, fig.width=8}
ctrl_filtered@active.assay <- "RNA"
# df <- FetchData(ctrl_filtered, c("celltype","salm","kni","ct", "vn", "wg", "bs"), slot = "data")
df <- FetchData(ctrl_filtered, c("celltype","mmy","fng","O-fut1","kud"), slot = "data")
df$barcode <- rownames(df)
dfData <- melt(df, id.vars = c('barcode', "celltype"), value.name="expression", variable.name='symbol')

ggplot(dfData,aes(x = barcode, y = expression, group=celltype, fill=celltype)) + ggalt::geom_horizon(colour = NA, size = 5, bandwidth = 10) + facet_grid(symbol~celltype, labeller = label_value, scales = "free", space = "free_x")  + xlab('glycosylation related proteins in HSD')  + ylab('') + theme_bw() + 
  scale_fill_manual(values = colors_list) + theme(strip.background.y = element_blank() ,strip.text.x = element_text(size = 8, color='black'), strip.text.y = element_text(hjust = 0 ,angle = 0,size = 12, color='black'), axis.text.y = element_blank(), axis.text.x = element_blank(), panel.grid = element_blank(), panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank(), axis.ticks.y = element_blank(),axis.ticks.x = element_blank(), panel.spacing.x = unit(0,"lines"), panel.spacing.y = unit(0.5,"lines")) # 分面的大小其实是可以修改的，需要同时设置scales和space
# ggsave("./figures/markergenes_new.png", dpi=256, height=3, width=6)
```

## fig 3 bubble plots
```{r}
Idents(ctrl_filtered) <- factor(ctrl_filtered$celltype,levels=c("DB","DT","SB","PC","TC","VB","LT","GB","ASP"))

Dotplot(c("exp","kni"),ctrl_filtered) + xlab("Gene") + ylab("Cell Type")
ggsave("./figures/fly10x figures/fig3_a.tiff",device = 'tiff', dpi = 300)

Dotplot(c("bs","mirr","bru2","wun"),ctrl_filtered) + xlab("Gene") + ylab("Cell Type")
ggsave("./figures/fly10x figures/fig3_f.tiff",device = 'tiff', dpi = 300)
```

## fig3 ij PC subclusters
```{r}
PC <- readRDS("./processed_data_file/PC_ctrl_subcluster.rds")
umapplot(PC)+ theme(axis.line = element_blank(),axis.title = element_blank(),legend.position = 'right')+coord_fixed(ratio = 1)
ggsave("./figures/fly10x figures/PC_subcluster_umapplot.tiff",device = 'tiff',width = 5, height = 5, dpi = 300)


PC_sub_markers <- FindAllMarkers(PC, logfc.threshold = 0.5, min.diff.pct = 0.2, only.pos = T)
top10markers <- PC_sub_markers %>% group_by(cluster) %>% slice_max(n = 10, order_by = avg_log2FC)
dhm(top10markers$gene, PC,text_size = 4, angle=0, hjust=0.5) 
ggsave("./figures/fly10x figures/PC_subclusters_markers.tiff", device = 'tiff', width = 10, height = 6)

```

## fig 4
```{r}
f("Tom",ctrl_filtered,label = F)+ theme(axis.line = element_blank(), axis.title = element_blank(),legend.position = 'none')+ggtitle("")+coord_fixed(ratio = 1) 
ggsave("./figures/fly10x figures/ctrl_Tom_exp.tiff",device = 'tiff', dpi = 300)

f("serp",ctrl_filtered,label = F)+ theme(axis.line = element_blank(), axis.title = element_blank(),legend.position = 'none')+ggtitle("")+coord_fixed(ratio = 1) 
ggsave("./figures/fly10x figures/ctrl_Serp_exp.tiff",device = 'tiff', dpi = 300)
```

## fig 5 
```{r}
#bubble plot
Dotplot(c("E(spl)m3-HLH","E(spl)m7-HLH"),ctrl_filtered) + xlab("Gene") + ylab("Cell Type")
ggsave("./figures/fly10x figures/fig5_bubble_E(spl).tiff",device = 'tiff', height=8, width=6, dpi = 300)

gene_name <- c("Tom","peb")
doublegene_featureplot(gene_name, ctrl_filtered)
ggsave(filename = paste0("./figures/fly10x figures/",gene_name[1],"vs",gene_name[2],".tiff"), device = tiff, height = 5, width = 20) 


plot_data <- FetchData(ctrl_filtered,vars = c("Tom","peb","UMAP_1","UMAP_2","celltype"))
ggplot(plot_data) +
    geom_point(aes(x = UMAP_1, y = UMAP_2, alpha = Tom + peb), shape = 16, size = 1, color = "lightgrey") +
    scale_alpha_continuous(range = c(0.5, 1)) +
    new_scale("alpha") +
    geom_point(aes(x = UMAP_1, y = UMAP_2, alpha = Tom), shape = 16, size = 1, color = "deeppink") +
    scale_alpha_continuous(range = c(0, 0.1)) +
    new_scale("alpha") +
    geom_point(aes(x = UMAP_1, y = UMAP_2, alpha = peb), shape = 16, size = 1, color = "#1E90FF") +
    scale_alpha_continuous(range = c(0, 0.1)) +
    coord_fixed() +
    theme(
        panel.background = element_blank(), panel.grid = element_blank(), axis.line = element_blank(), axis.title = element_blank(), legend.position = "none",
        axis.text = element_blank(), axis.ticks = element_blank(),
    )


ggplot(plot_data) +
    geom_point(aes(x = UMAP_1, y = UMAP_2, alpha = Tom + peb), shape = 16, size = 1, color = "lightgrey") +
    scale_alpha_continuous(range = c(0.5, 1)) +
    new_scale("alpha") +
    geom_point(aes(x = UMAP_1, y = UMAP_2, alpha = Tom), shape = 16, size = 1, color = "deeppink") +
    scale_alpha_continuous(range = c(0, 0.1)) +
    coord_fixed() +
    theme(
        panel.background = element_blank(), panel.grid = element_blank(), axis.line = element_blank(), axis.title = element_blank(), legend.position = "none",
        axis.text = element_blank(), axis.ticks = element_blank(),
    )
```

# fig 7 ridge plot
```{r}
# PC_DB_DT <- readRDS("./processed_data_file/PC_DB_DT_seurat.rds")
PC_DB_DT <- PC_DB_DT %>% ScaleData(vars.to.regress='percent.mt')
PC_DB_DT@active.assay <- "SCT"
df <- FetchData(PC_DB_DT,vars =  c("Tom","kni","bs","ct","peb","pseudotime","celltype"),slot ="data")
data <- cbind(df,index = 1:nrow(df),cluster = Idents(PC_DB_DT))

for(selected_gene in c("Tom","kni","bs","ct","peb")){
  # selected_gene <- 'ct'
ggplot(data,aes(x=pseudotime,y=eval(parse(text=selected_gene)))) + geom_point(aes(color = cluster),alpha = 0.2) + geom_smooth(color = "red") + theme_classic() + ridgetheme + scale_color_manual(values = colors_list) + guides(colour = guide_legend(override.aes = list(size=10)))+ ylim(0,max(df[selected_gene])) + ylab(selected_gene)

ggsave(paste0("./figures/fly10x figures/",selected_gene,"_with_pseudotime.tiff"),device = 'tiff', height=5, width=5, dpi = 300)
}
```
# figure supplement
## upset plot for cluster-specific TFs coexpression
```{r}
# library(UpSetR)
devtools::load_all("./utils/UpSetR-master", export_all = TRUE)
Idents(ctrl_filtered) <- ctrl_filtered$celltype

all_selected_TFs <- list('ASP'=c("ken","klu","Aef1","slbo"),'DB'=c('BEAF-32','tgo',"kni","HDAC1"),'DT'=c("crol","Dref","Dp",'salm'),'GB'=c('ERR','Rel',"CG7372","dl"),'LT'=c("sima","abd-A","Usf","Hnf4"),'PC'=c('bs','pnt','ct','Trf2'),'SB'=c("wg","Atf3","grn","ct"),"TC"=c('bi',"Usf","ara","ct"),"VB"=c("Myc","Max","BEAF-32","vn"))

for(idx in seq(length(levels(Idents(ctrl_filtered))))){
  
  cell_cluster <- levels(Idents(ctrl_filtered))[idx]
  selected_TFs <- all_selected_TFs[[cell_cluster]]
  temp <- subset(ctrl_filtered, idents=cell_cluster)
  df <- FetchData(temp, selected_TFs)
  ls <- lapply(df, function(x){which(x>0)})
  no_expressed <- which(rowSums(df)==0)
  names(no_expressed) <- NULL
  ls$none <- no_expressed

  svg(paste0("./figures/upset_plot/",cell_cluster,".svg"))
  print(upset(fromList(ls), order.by = "freq", keep.order = F,text.scale=2, matrix.color = "black",main.bar.color='black',point.size=4, sets.bar.color = "black",mainbar.y.label='#cell',sets.x.label='marginal size', percentage = TRUE, mainbar.y.max=NULL, nintersects = 12)) #循环保存要用print
  dev.off()
}

```

```{r , fig.width=4, fig.height=4}
# test UpSetR
# source("./utils/UpSetR-master/R/upset.R")
devtools::load_all("./utils/UpSetR-master", export_all = TRUE)
upset(fromList(ls), order.by = "freq", keep.order = F,text.scale=2, matrix.color = "black",main.bar.color='black',point.size=4, sets.bar.color = "black",mainbar.y.label='#cell',sets.x.label='marginal size', percentage = TRUE)
```

```{r}
idx <- 5
cell_cluster <- levels(Idents(ctrl_filtered))[idx]
selected_TFs <- all_selected_TFs[[cell_cluster]]
temp <- subset(ctrl_filtered, idents=cell_cluster)
df <- FetchData(temp, selected_TFs)
ls <- lapply(df, function(x){which(x>0)})
no_expressed <- which(rowSums(df)==0)
names(no_expressed) <- NULL
ls$none <- no_expressed
svg(paste0("./temp/",cell_cluster,".svg"))
print(upset(fromList(ls), order.by = "freq", nsets=6, nintersects = 20, keep.order = F,text.scale=2, matrix.color = "black",main.bar.color='black',point.size=4, sets.bar.color = "black",mainbar.y.label='#cell',sets.x.label='marginal size', percentage = TRUE)) #循环保存要用print
dev.off()
```

# neuropeptides 
```{r}
# HSD_filtered <- readRDS("./processed_data_file/HSD_filtered.rds")
# Idents(HSD_filtered) <- HSD_filtered$celltype
for(g in intersect(c("AstA","Akh","Capa","CCAP","Crz","Dh31","Dh44","Ilp1","Ilp3","Ilp5","Ilp7","Dsk","Hug","Lk","Mip","NPF","Burs","Orcokinin"), rownames(ctrl_filtered))){
    
  print(plot_grid(
        plotlist = lapply(c(ctrl_filtered, HSD_filtered), function(x,g){f(g,x)}, g),
        ncol = 1, nrow = 2))}

```
```{r}
fly_merge <- readRDS("./processed_data_file/fly_merge.rds")
for(g in intersect(c("AstA","Akh","Capa","CCAP","Crz","Dh31","Dh44","Ilp1","Ilp3","Ilp5","Ilp7","Dsk","Hug","Lk","Mip","NPF","Burs","Orcokinin"), rownames(fly_merge))){
    print(f(g, fly_merge, split.by='orig.ident'))
}
```

# cytokines
```{r cytokines, fig.height=3, fig.width=3}
cytokines <- intersect(c("upd1","upd2","upd3","hop","egr","Pvf1","Pvf2","Pvf3","spz","NT1","spz3","spz4","spz5","spz6","Gbp1","Gbp2"), rownames(ctrl_filtered))
for(g in cytokines){
    
  print(plot_grid(
        plotlist = lapply(c(ctrl_filtered, HSD_filtered), function(x,g){f(g,x)}, g),
        ncol = 1, nrow = 2))
  ggsave(paste0("./figures/cytokines/",g,".png"), dpi=256)
  }
  
```

```{r}
# Idents(fly_merge_filtered) <- fly_merge_filtered$orig.ident
# fly_merge_filtered <- RenameIdents(fly_merge_filtered, '1'='ctrl','2'='HSD', '3'='HSD')
DotPlot(fly_merge_filtered, features = cytokines, cols = c("#b1d6fb", "#fd9999"), scale = F, col.min = 0) +
         theme_classic() + theme(text = element_text(colour = "black", size = 16), 
                                 plot.title = element_text(size = 16,color="black",hjust = 0.5),
                                 axis.title = element_text(size = 16,color ="black"), 
                                 axis.text = element_text(size = 16,color = "black"))+coord_flip()
ggsave(paste0("./figures/cytokines/dotplot.png"), dpi=256)
```


```{r}
cytokine_expression <- FetchData(fly_merge_filtered,  vars = c(cytokines,"ident"))
cytokine_expression[cytokine_expression == 0] <- NA # for nonzero test
# reshape2::melt(cytokine_expression)
cytokine_result <- compare_means(formula(paste0(reg_vector(cytokines),"~ ident")),cytokine_expression, method = "wilcox.test",ref.group='ctrl')
write.csv(cytokine_result, "./data_tables/cytokines_nonzero_test.csv")
cytokine_result
```

```{r}
tnf_receptor <- intersect(c("grnd","wgn"), rownames(ctrl_filtered))

Dotplot(tnf_receptor, fly_merge_filtered, scale = F)+coord_flip()

tnf_receptor_expression <- FetchData(fly_merge_filtered,  vars = c(tnf_receptor,"ident"))
# tnf_receptor_expression[tnf_receptor_expression == 0] <- NA # for nonzero test

compare_means(formula(paste0(reg_vector(tnf_receptor),"~ ident")),tnf_receptor_expression, method = "wilcox.test",ref.group='ctrl')
```

```{r}
dd <- FindMarkers(subset(fly_merge_filtered, celltype == 'PC'), ident.1 = "HSD", ident.2 = "ctrl", test.use = "wilcox", logfc.threshold = 0.5, min.pct = 0.1, min.diff.pct = 0.1, only.pos = F, pseudocount.use=0) # pseudocount is set to 0, consistent with compare_means function
dd$gene <- rownames(dd)

temp_func("PC") %>% filter(.y. %in% c("mmy","fng","kud","O-fut1"))

gly_protein <- c("mmy","fng","kud","O-fut1")

temp_func <- function(cell_cluster){
  seuobj <- subset(fly_merge_filtered, celltype == cell_cluster)
  # Dotplot(gly_protein, seuobj, scale = F)+coord_flip()
  gly_protein_expression <- FetchData(seuobj,  vars = c(gly_protein,"ident"))
gly_protein_expression[gly_protein_expression == 0] <- NA # for nonzero test
  df <- compare_means(formula(paste0(reg_vector(gly_protein),"~ ident")),gly_protein_expression, method = "wilcox.test",ref.group='ctrl', p.adjust.method = "bonferroni")
  gly_protein_expression %>% group_by(ident) %>% summarise(avg = mean(mmy, na.rm = TRUE))
  df[,c('ctrl', 'HSD')] <- sapply(df$.y., function(x){res <- gly_protein_expression %>% group_by(ident) %>% summarise(avg = mean(paste0("`", as.character(x), "`") %>% parse(text=.) %>% eval(), na.rm = TRUE))
  res$avg}) %>% t()
  df$cluster <- cell_cluster
  return(df)
}
merged_compare_result <- lapply(unique(fly_merge_filtered$celltype), temp_func) %>% Reduce(rbind, .)
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
